---
title: Android 6.0 默认关闭USB调试
slug: 184a6316bae54c358a1c6135bd98fa54
tags:
  - aosp
  - android
date: 2025-07-01T06:34:22.284Z
---

# Android 6.0 默认关闭USB调试

**文件路径**: `packages/SystemUI/src/com/android/systemui/SystemUIService.java`\
**修改目的**: 在系统服务启动时强制关闭USB调试（ADB），并确保只执行一次

#### 修改后的代码片段

```java
public class SystemUIService extends Service {

    @Override
    public void onCreate() {
        super.onCreate();
        ((SystemUIApplication) getApplication()).startServicesIfNeeded();
        
        // 新增逻辑：首次启动时禁用ADB
        int i = Global.getInt(getContentResolver(), "liuhui", 0);
        if (i == 0) {
            Log.i("neil", "i = " + i);
            // 关键操作：关闭USB调试
            Settings.Global.putInt(getContentResolver(), Settings.Global.ADB_ENABLED, 0);
            // 设置标志位防止重复执行
            Global.putInt(getContentResolver(), "liuhui", 1);
        }
        // else {
        //   Log.i("neil","i2 = "+i);  // 调试日志（已注释）
        // }
    }
}
```

#### 关键逻辑说明

1. **状态检查**

   ```java
   int i = Global.getInt(getContentResolver(), "liuhui", 0);
   ```

   查询自定义标记`liuhui`的值（默认0表示未初始化）

2. **关闭ADB的条件**

   ```java
   if (i == 0) {
       Settings.Global.putInt(getContentResolver(), Settings.Global.ADB_ENABLED, 0);
       Global.putInt(getContentResolver(), "liuhui", 1);
   }
   ```

   - 当标记为0时：

     - 通过`Settings.Global.ADB_ENABLED`禁用USB调试

     - 将标记`liuhui`更新为1（确保只执行一次）

3. **日志跟踪**

   - 成功执行时输出日志`i = 0`（生产环境可移除）

   - 已注释的日志用于调试重复执行情况

#### 注意事项

- **执行时机**：在系统UI服务初始化时触发（`onCreate`阶段）

- **持久化存储**：使用`Settings.Global`存储标志位，设备重启后仍有效

- **影响范围**：首次启动后永久关闭ADB，需手动开启或清除系统设置才能恢复

***

### 使用建议

1. **安全增强**：适用于需要默认锁定ADB的设备（如Kiosk模式）

2. **生产部署**：移除调试日志`Log.i`避免泄露敏感信息

3. **重置方式**：

   ```bash
   adb shell settings put global liuhui 0  # 重置标记位
   adb shell settings put global adb_enabled 1  # 手动启用ADB
   ```
