---
title: Android 15 弹窗控制修改：隐藏应用版本低或版本不兼容提示
slug: e29a6913e94e4a32a8f180db03c3a8d9
tags:
  - android
date: 2026-01-28T12:19:42.022Z
---

## 修改内容概述

本次修改在 Android 15 公版系统中，**新增一个系统属性 `ro.kte.show_deprecated_dialogs`** 来控制是否显示以下两种弹窗：

1. **ABI 已废弃提示弹窗**（DeprecatedAbiDialog）

2. **目标 SDK 版本过低提示弹窗**（DeprecatedTargetSdkVersionDialog）

当该属性为 `false` 时，**不显示弹窗**，直接设置相应的标志位；当为 `true` 时，**显示弹窗**。

## 完整修改内容

```diff
--- a/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedAbiDialog.java
+++ b/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedAbiDialog.java
@@ -31,28 +31,40 @@ class DeprecatedAbiDialog extends AppWarnings.BaseDialog {
             ApplicationInfo appInfo, int userId) {
         super(manager, context, appInfo.packageName, userId);
 
-        final PackageManager pm = context.getPackageManager();
-        final CharSequence label = appInfo.loadSafeLabel(pm,
-                PackageItemInfo.DEFAULT_MAX_LABEL_SIZE_PX,
-                PackageItemInfo.SAFE_LABEL_FLAG_FIRST_LINE
-                        | PackageItemInfo.SAFE_LABEL_FLAG_TRIM);
-        final CharSequence message = context.getString(R.string.deprecated_abi_message);
-
-        final AlertDialog.Builder builder = new AlertDialog.Builder(context)
-                .setPositiveButton(R.string.ok, (dialog, which) ->
-                    manager.setPackageFlag(
-                            mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_ABI, true))
-                .setMessage(message)
-                .setTitle(label);
-
-        // Ensure the content view is prepared.
-        mDialog = builder.create();
-        mDialog.create();
-
-        final Window window = mDialog.getWindow();
-        window.setType(WindowManager.LayoutParams.TYPE_PHONE);
-
-        // DO NOT MODIFY. Used by CTS to verify the dialog is displayed.
-        window.getAttributes().setTitle("DeprecatedAbiDialog");
+        // 检查是否应该显示弹框，例如根据系统属性
+        boolean shouldShowDialog = android.os.SystemProperties.getBoolean(
+            "ro.kte.show_deprecated_dialogs", false);
+
+        if (shouldShowDialog) {
+            // 原显示弹框的代码
+            final PackageManager pm = context.getPackageManager();
+            final CharSequence label = appInfo.loadSafeLabel(pm,
+                    PackageItemInfo.DEFAULT_MAX_LABEL_SIZE_PX,
+                    PackageItemInfo.SAFE_LABEL_FLAG_FIRST_LINE
+                            | PackageItemInfo.SAFE_LABEL_FLAG_TRIM);
+            final CharSequence message = context.getString(R.string.deprecated_abi_message);
+
+            final AlertDialog.Builder builder = new AlertDialog.Builder(context)
+                    .setPositiveButton(R.string.ok, (dialog, which) ->
+                        manager.setPackageFlag(
+                                mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_ABI, true))
+                    .setMessage(message)
+                    .setTitle(label);
+
+            // Ensure the content view is prepared.
+            mDialog = builder.create();
+            mDialog.create();
+
+            final Window window = mDialog.getWindow();
+            window.setType(WindowManager.LayoutParams.TYPE_PHONE);
+
+            // DO NOT MODIFY. Used by CTS to verify the dialog is displayed.
+            window.getAttributes().setTitle("DeprecatedAbiDialog");
+        } else {
+            // 不显示弹框，直接设置标志位
+            manager.setPackageFlag(
+                mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_ABI, true);
+            mDialog = null;
+        }
     }
 }
diff --git a/kte_project/android/public/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedTargetSdkVersionDialog.java b/kte_project/android/public/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedTargetSdkVersionDialog.java
old mode 100644
new mode 100755
index ce4238582b2..25115a2030c
--- a/kte_project/android/public/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedTargetSdkVersionDialog.java
+++ b/kte_project/android/public/system/frameworks/base/services/core/java/com/android/server/wm/DeprecatedTargetSdkVersionDialog.java
@@ -34,37 +34,49 @@ class DeprecatedTargetSdkVersionDialog extends AppWarnings.BaseDialog {
             ApplicationInfo appInfo, int userId) {
         super(manager, context, appInfo.packageName, userId);
 
-        final PackageManager pm = context.getPackageManager();
-        final CharSequence label = appInfo.loadSafeLabel(pm,
-                PackageItemInfo.DEFAULT_MAX_LABEL_SIZE_PX,
-                PackageItemInfo.SAFE_LABEL_FLAG_FIRST_LINE
-                        | PackageItemInfo.SAFE_LABEL_FLAG_TRIM);
-        final CharSequence message = context.getString(R.string.deprecated_target_sdk_message);
+        // 检查是否应该显示弹框，例如根据系统属性
+        boolean shouldShowDialog = android.os.SystemProperties.getBoolean(
+            "ro.kte.show_deprecated_dialogs", false);
 
-        final AlertDialog.Builder builder = new AlertDialog.Builder(context)
-                .setPositiveButton(R.string.ok, (dialog, which) ->
-                    manager.setPackageFlag(
-                            mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_SDK, true))
-                .setMessage(message)
-                .setTitle(label);
+        if (shouldShowDialog) {
+            // 原显示弹框的代码
+            final PackageManager pm = context.getPackageManager();
+            final CharSequence label = appInfo.loadSafeLabel(pm,
+                    PackageItemInfo.DEFAULT_MAX_LABEL_SIZE_PX,
+                    PackageItemInfo.SAFE_LABEL_FLAG_FIRST_LINE
+                            | PackageItemInfo.SAFE_LABEL_FLAG_TRIM);
+            final CharSequence message = context.getString(R.string.deprecated_target_sdk_message);
 
-        // If we might be able to update the app, show a button.
-        final Intent installerIntent = AppInstallerUtil.createIntent(context, appInfo.packageName);
-        if (installerIntent != null) {
-            builder.setNeutralButton(R.string.deprecated_target_sdk_app_store,
-                    (dialog, which) -> {
-                        context.startActivity(installerIntent);
-                    });
-        }
+            final AlertDialog.Builder builder = new AlertDialog.Builder(context)
+                    .setPositiveButton(R.string.ok, (dialog, which) ->
+                        manager.setPackageFlag(
+                                mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_SDK, true))
+                    .setMessage(message)
+                    .setTitle(label);
+
+            // If we might be able to update the app, show a button.
+            final Intent installerIntent = AppInstallerUtil.createIntent(context, appInfo.packageName);
+            if (installerIntent != null) {
+                builder.setNeutralButton(R.string.deprecated_target_sdk_app_store,
+                        (dialog, which) -> {
+                            context.startActivity(installerIntent);
+                        });
+            }
 
-        // Ensure the content view is prepared.
-        mDialog = builder.create();
-        mDialog.create();
+            // Ensure the content view is prepared.
+            mDialog = builder.create();
+            mDialog.create();
 
-        final Window window = mDialog.getWindow();
-        window.setType(WindowManager.LayoutParams.TYPE_PHONE);
+            final Window window = mDialog.getWindow();
+            window.setType(WindowManager.LayoutParams.TYPE_PHONE);
 
-        // DO NOT MODIFY. Used by CTS to verify the dialog is displayed.
-        window.getAttributes().setTitle("DeprecatedTargetSdkVersionDialog");
+            // DO NOT MODIFY. Used by CTS to verify the dialog is displayed.
+            window.getAttributes().setTitle("DeprecatedTargetSdkVersionDialog");
+        } else {
+            // 不显示弹框，直接设置标志位
+            manager.setPackageFlag(
+                mUserId, mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_SDK, true);
+            mDialog = null;
+        }
     }
 }

```

***

## 使用说明

### 控制属性

- **属性名**: `ro.kte.show_deprecated_dialogs`

- **默认值**: `false`（不显示弹窗）

- **设置为 `true`**: 显示 ABI 或 SDK 版本过低的提示弹窗

- **设置为 `false`**: 不显示弹窗，直接设置隐藏标志位

### 设置方法（adb）

bash

\# 开启弹窗显示\
adb shell setprop ro.kte.show\_deprecated\_dialogs true

\# 关闭弹窗显示\
adb shell setprop ro.kte.show\_deprecated\_dialogs false

### 影响范围

- **DeprecatedAbiDialog**: 应用 ABI 不兼容时的提示

- **DeprecatedTargetSdkVersionDialog**: 应用目标 SDK 版本过低时的提示

***

## 备注

- 该修改适用于 **Android 15 公版系统**。

- 修改后可通过系统属性灵活控制弹窗显示，便于定制化场景使用（如客制化 ROM、测试环境等）。
