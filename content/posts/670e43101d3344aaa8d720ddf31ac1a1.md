---
title: Android 12 å·®åˆ†åŒ…åˆ¶ä½œæŒ‡å—
slug: 670e43101d3344aaa8d720ddf31ac1a1
tags:
  - android
date: 2025-07-02T11:02:22.705Z
---

## ðŸ“ å®Œæ•´å·®åˆ†åŒ…åˆ¶ä½œæµç¨‹

### æ ¸å¿ƒå‘½ä»¤

```bash
# ä½¿ç”¨ç³»ç»Ÿç¼–è¯‘ç”Ÿæˆçš„å·¥å…·
out/host/linux-x86/bin/ota_from_target_files -v --block --path out/host/linux-x86/ -i old_target_files.zip new_target_files.zip ota_update.zip
```

### åŠ é€ŸABå‡çº§é€‰é¡¹

```bash
# æ·»åŠ è·³è¿‡postinstallå’ŒFECè®¡ç®—çš„å‚æ•°
out/host/linux-x86/bin/ota_from_target_files \
  --disable_fec_computation \
  --skip_postinstall \
  ... # å…¶ä»–å‚æ•°åŒä¸Š
```

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. çŽ¯å¢ƒè¦æ±‚

- **Ubuntu 18.04** (æŽ¨è)

- Python 2.7 (Android 12ä»ä½¿ç”¨Python 2)

- å·²å®‰è£…Androidç¼–è¯‘çŽ¯å¢ƒ

- å·²ç¼–è¯‘å®Œæ•´ç³»ç»Ÿ (`make -j8`)

### 2. æ–‡ä»¶å‡†å¤‡

| æ–‡ä»¶ç±»åž‹                   | ç”Ÿæˆæ–¹å¼        | è¯´æ˜Ž      |
| ---------------------- | ----------- | ------- |
| old\_target\_files.zip | `make dist` | æ—§ç‰ˆæœ¬ç›®æ ‡æ–‡ä»¶ |
| new\_target\_files.zip | `make dist` | æ–°ç‰ˆæœ¬ç›®æ ‡æ–‡ä»¶ |
| ota\_update.zip        | æœ¬å‘½ä»¤ç”Ÿæˆ       | å·®åˆ†åŒ…è¾“å‡ºæ–‡ä»¶ |

### 3. å‚æ•°è¯´æ˜Ž

| å‚æ•°                          | ä½œç”¨            | æŽ¨èå€¼                   |
| --------------------------- | ------------- | --------------------- |
| `-v`                        | è¯¦ç»†è¾“å‡º          | å§‹ç»ˆå¯ç”¨                  |
| `--block`                   | ä½¿ç”¨å—å¢žé‡æ›´æ–°       | å¿…é¡»å¯ç”¨                  |
| `--path`                    | å·¥å…·ä¾èµ–è·¯å¾„        | `out/host/linux-x86/` |
| `-i`                        | å¢žé‡æ¨¡å¼          | åŽæŽ¥æ—§ç‰ˆæœ¬zip              |
| `--disable_fec_computation` | ç¦ç”¨FECè®¡ç®—       | åŠ é€Ÿåˆ¶ä½œ                  |
| `--skip_postinstall`        | è·³è¿‡postinstall | åŠ é€Ÿå®‰è£…                  |

## ðŸ”§ å¸¸è§é”™è¯¯è§£å†³æ–¹æ¡ˆ

### é”™è¯¯ï¼š`ImportError: No module named google.protobuf`

```bash
# å®‰è£…Python 2çš„protobuf
sudo apt-get install python-protobuf

# æˆ–ä½¿ç”¨pipå®‰è£…
pip install protobuf==3.19.4 --user
```

### é”™è¯¯ï¼š`Warning: releasetools script should be invoked as hermetic Python executable`

**æ­£ç¡®åšæ³•**ï¼š

```bash
# ä¸è¦ä½¿ç”¨æºç ä¸­çš„è„šæœ¬
âŒ ./build/tools/releasetools/ota_from_target_files ...

# åº”ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ç‰ˆæœ¬
âœ… out/host/linux-x86/bin/ota_from_target_files ...
```

### å…¶ä»–ä¾èµ–é—®é¢˜

```bash
# å®‰è£…æ‰€æœ‰å¿…è¦ä¾èµ–
sudo apt-get install \
  python-dev \
  python-protobuf \
  python-pil \
  python-six \
  python-zlib \
  libssl-dev
```

## âš™ï¸ é«˜çº§é…ç½®é€‰é¡¹

### 1. å¯†é’¥é…ç½®

```bash
# ä½¿ç”¨è‡ªå®šä¹‰ç­¾åå¯†é’¥
ota_from_target_files \
  --package_key build/make/target/product/security/testkey \
  ... # å…¶ä»–å‚æ•°
```

### 2. å¢žé‡ç­–ç•¥ä¼˜åŒ–

```bash
# ä»…æ›´æ–°ç‰¹å®šåˆ†åŒº
ota_from_target_files \
  --dynamic_partition_list system,vendor \
  ... # å…¶ä»–å‚æ•°
```

### 3. æ·»åŠ é¢å¤–æ–‡ä»¶

```bash
# åŒ…å«é¢å¤–è„šæœ¬
ota_from_target_files \
  --post_install_script device/extra/update-script.sh \
  ... # å…¶ä»–å‚æ•°
```

## ðŸ“Š ä¸åŒç¼–è¯‘æ¨¡å¼å¯¹æ¯”

| ç¼–è¯‘ç±»åž‹                  | åˆ¶ä½œå‘½ä»¤                                  | è¾“å‡ºæ–‡ä»¶              | é€‚ç”¨åœºæ™¯    |
| --------------------- | ------------------------------------- | ----------------- | ------- |
| **Split build**       | `make dist` + `ota_from_target_files` | target\_files.zip | æ­£å¼OTAå‘å¸ƒ |
| **Full build**        | `make otapackage`                     | å®Œæ•´OTAåŒ…            | æœ¬åœ°æµ‹è¯•    |
| **Incremental build** | `make incremental_ota`                | å¢žé‡åŒ…               | å¿«é€Ÿè¿­ä»£    |

## ðŸ’¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. å¹¶è¡Œå¤„ç†

```bash
# ä½¿ç”¨å¤šæ ¸åŠ é€Ÿ
ota_from_target_files \
  --worker_threads $(nproc) \
  ... # å…¶ä»–å‚æ•°
```

### 2. ç¼“å­˜ä¼˜åŒ–

```bash
# è®¾ç½®ä¸´æ—¶æ–‡ä»¶ç›®å½•
export TMPDIR=/ssd/tmp  # ä½¿ç”¨SSDåŠ é€Ÿ
mkdir -p $TMPDIR
```

### 3. å†…å­˜ä¼˜åŒ–

```bash
# å¢žåŠ Javaå †å¤§å°
export JAVA_OPTS="-Xmx8g -Xms2g"
```

## âš ï¸ å¸¸è§é—®é¢˜æŽ’æŸ¥

### é—®é¢˜ï¼šå·®åˆ†åŒ…ç”Ÿæˆå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ç‰ˆæœ¬è¿žç»­æ€§ï¼š

   ```bash
   # ç¡®ä¿æ˜¯è¿žç»­ç‰ˆæœ¬
   grep ro.build.fingerprint old/build.prop
   grep ro.build.fingerprint new/build.prop
   ```

2. éªŒè¯åˆ†åŒºå¤§å°ï¼š

   ```bash
   # æ£€æŸ¥åˆ†åŒºå¤§å°æ˜¯å¦ä¸€è‡´
   grep partition_size old/META/misc_info.txt
   grep partition_size new/META/misc_info.txt
   ```

### é—®é¢˜ï¼šè®¾å¤‡ç«¯æ›´æ–°å¤±è´¥

**æ£€æŸ¥ç‚¹**ï¼š

1. è®¾å¤‡å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶³

2. å½“å‰ç³»ç»Ÿç‰ˆæœ¬æ˜¯å¦åŒ¹é…æ—§ç‰ˆæœ¬

3. Bootloaderç‰ˆæœ¬æ˜¯å¦å…¼å®¹

4. ç­¾åå¯†é’¥æ˜¯å¦åŒ¹é…

## ðŸ“± å·®åˆ†åŒ…åº”ç”¨éªŒè¯

```bash
# æŽ¨é€åˆ°è®¾å¤‡æµ‹è¯•
adb push update.zip /sdcard/

# è¿›å…¥recoveryæ¨¡å¼
adb reboot recovery

# åº”ç”¨æ›´æ–°
adb sideload update.zip
```

> ðŸ’¡ **ä¸“ä¸šæç¤º**ï¼šå¯¹äºŽç”Ÿäº§çŽ¯å¢ƒï¼Œå»ºè®®æ·»åŠ ç‰ˆæœ¬éªŒè¯æ­¥éª¤ï¼š
>
> ```bash
> # éªŒè¯ç‰ˆæœ¬è¿žç»­æ€§
> ota_from_target_files --verify \
>   -i old-target_files.zip \
>   new-target_files.zip
> ```
