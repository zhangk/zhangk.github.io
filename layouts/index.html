{{ define "main" }}
<!doctype html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <!-- è®©Hugoæ’å…¥ä¸»é¢˜çš„æ‰€æœ‰å¤´éƒ¨å…ƒç´ ï¼ˆCSSã€Metaç­‰ï¼‰ -->
    {{ partial "head.html" . }}
    <style>
        /* æˆ‘ä»¬è‡ªå®šä¹‰çš„å¯†ç é¡µæ ·å¼ï¼Œä»…åœ¨æœªè®¤è¯æ—¶ç”Ÿæ•ˆ */
        .auth-body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .auth-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.1); text-align: center; }
        #blogContainer { display: none; } /* åˆå§‹éšè—åšå®¢å®¹å™¨ */
    </style>
    <!-- æ³¨å…¥æ–‡ç« æ•°æ® -->
    {{ partial "blog-data.html" . }}
</head>
<body class="auth-body">
    <!-- å¯†ç éªŒè¯ç•Œé¢ -->
    <div id="authBox" class="auth-box">
        <h2>ğŸ”’ ç§äººåšå®¢</h2>
        <p>è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š</p>
        <input type="password" id="passwordInput" placeholder="å¯†ç " autofocus />
        <button onclick="validatePassword()">è¿›å…¥</button>
        <p id="errorMsg" style="color: red; display: none;">å¯†ç é”™è¯¯</p>
    </div>

    <!-- åšå®¢å†…å®¹å®¹å™¨ (éªŒè¯åæ˜¾ç¤º) -->
    <!-- è¿™é‡Œå°†åŒ…è£¹æ•´ä¸ªä¸»é¢˜çš„ body å†…å®¹ -->
    <div id="blogContainer">
        <!-- ä¸»é¢˜çš„å¤´éƒ¨å¯¼èˆªæ  (åº”åŒ…å«æœç´¢æ¡†) -->
        {{ partial "header.html" . }}
        
        <!-- ä¸»é¢˜çš„ä¸»å†…å®¹åŒºåŸŸ -->
        <main>
            <!-- è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼Œæˆ‘ä»¬ç¨åå¡«å…… -->
            <div id="dynamicContent">
                <h1>æˆ‘çš„åšå®¢</h1>
                <div id="articleList"></div>
            </div>
        </main>
        
        <!-- ä¸»é¢˜çš„é¡µè„šç­‰ -->
        {{ partial "footer.html" . }}
    </div>

    <!-- è®©Hugoæ’å…¥ä¸»é¢˜çš„æ‰€æœ‰å°¾éƒ¨JSï¼ˆåŒ…æ‹¬æœç´¢åŠŸèƒ½ï¼‰ -->
    {{ partial "foot.html" . }}

    <script>
        const correctHash = 'ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f';
        const siteData = window.__HUGO_SITE_DATA__ || { pages: [] };

        console.log('[Auth] è„šæœ¬åŠ è½½ã€‚Correct hash (å‰6ä½):', correctHash.substring(0, 6));
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initAuth() {
            console.log('[Auth] initAuth æ‰§è¡Œ');
            const savedHash = localStorage.getItem('auth_hash');
            console.log('[Auth] ä» localStorage è¯»å–çš„ savedHash:', savedHash);
        
            // å…³é”®é€»è¾‘ï¼šåªæœ‰å“ˆå¸Œå®Œå…¨ä¸€è‡´æ‰è§†ä¸ºå·²è®¤è¯
            if (savedHash === correctHash) {
                console.log('[Auth] å“ˆå¸ŒåŒ¹é…ï¼Œæ‰§è¡Œ showBlogContent()');
                showBlogContent();
            } else {
                console.log('[Auth] æœªè®¤è¯æˆ–å“ˆå¸Œä¸åŒ¹é…ï¼Œæ‰§è¡Œ showPasswordPage()');
                showPasswordPage();
            }
        }
        
        // ä¸“é—¨æ˜¾ç¤ºå¯†ç é¡µçš„å‡½æ•°
        function showPasswordPage() {
            console.log('[Auth] æ˜¾ç¤ºå¯†ç é¡µ');
            // 1. ç¡®ä¿ body æœ‰æ­£ç¡®æ ·å¼ç±»
            document.body.classList.add('auth-body');
            // 2. ç¡®ä¿å¯†ç æ¡†å®¹å™¨æ˜¾ç¤º
            const authBox = document.getElementById('authBox');
            if (authBox) authBox.style.display = 'block';
            // 3. ç¡®ä¿åšå®¢å®¹å™¨éšè—
            const blogContainer = document.getElementById('blogContainer');
            if (blogContainer) blogContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤ºåšå®¢å†…å®¹çš„å‡½æ•°
        function showBlogContent() {
            console.log('[Auth] æ˜¾ç¤ºåšå®¢å†…å®¹');
            // 1. ç§»é™¤å¯†ç é¡µæ ·å¼
            document.body.classList.remove('auth-body');
            // 2. éšè—å¯†ç æ¡†
            const authBox = document.getElementById('authBox');
            if (authBox) authBox.style.display = 'none';
            // 3. æ˜¾ç¤ºåšå®¢å®¹å™¨
            const blogContainer = document.getElementById('blogContainer');
            if (blogContainer) blogContainer.style.display = 'block';
            // 4. æ¸²æŸ“æ–‡ç« åˆ—è¡¨
            renderArticleList();
        }
        
        // å¯†ç éªŒè¯å‡½æ•°
        async function validatePassword() {
            console.log('[Auth] å°è¯•éªŒè¯å¯†ç ');
            const input = document.getElementById('passwordInput').value;
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const inputHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
            console.log('[Auth] è¾“å…¥è®¡ç®—å‡ºçš„ hash (å‰6ä½):', inputHash.substring(0, 6));
        
            if (inputHash === correctHash) {
                console.log('[Auth] å¯†ç æ­£ç¡®ï¼Œå­˜å‚¨ hash å¹¶åˆ‡æ¢ç•Œé¢');
                localStorage.setItem('auth_hash', inputHash);
                showBlogContent();
            } else {
                console.log('[Auth] å¯†ç é”™è¯¯');
                document.getElementById('errorMsg').style.display = 'block';
            }
        }
        
        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨å‡½æ•°ï¼ˆè¯·ç¡®ä¿è¿™æ˜¯ä½ ä¸Šæ¬¡æˆåŠŸæ˜¾ç¤ºåˆ—è¡¨çš„ç‰ˆæœ¬ï¼‰
        function renderArticleList() {
            console.log('[Auth] æ¸²æŸ“æ–‡ç« åˆ—è¡¨ï¼Œæ•°æ®é‡:', siteData.pages.length);
            const container = document.getElementById('articleList');
            if (!container) {
                console.error('[Auth] é”™è¯¯ï¼šæœªæ‰¾åˆ° #articleList å…ƒç´ ');
                return;
            }
            if (!siteData.pages || siteData.pages.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ–‡ç« ã€‚</p>';
                return;
            }
            let html = '<ul>';
            const articles = siteData.pages
                .filter(p => p.type.replace(/^"|"$/g, '') === 'posts')
                .sort((a, b) => new Date(b.date.replace(/^"|"$/g, '')) - new Date(a.date.replace(/^"|"$/g, '')));
        
            articles.forEach(article => {
                const cleanTitle = article.title.replace(/^"|"$/g, '');
                const cleanPermalink = article.permalink.replace(/^"|"$/g, '');
                const cleanDate = article.date.replace(/^"|"$/g, '');
                html += `
                    <li>
                        <a href="${cleanPermalink}">
                            <strong>${cleanTitle}</strong>
                        </a>
                        <span style="color:#666; font-size:0.9em;"> - ${new Date(cleanDate).toLocaleDateString('zh-CN')}</span>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
            console.log('[Auth] æ–‡ç« åˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œæ–‡ç« æ•°:', articles.length);
        }
        
        // å¯åŠ¨ï¼šç›‘å¬é¡µé¢åŠ è½½
        window.addEventListener('DOMContentLoaded', initAuth);
        // é˜²æŠ–ï¼šå¦‚æœDOMæ—©å·²åŠ è½½å®Œæˆï¼Œåˆ™ç›´æ¥æ‰§è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuth);
        } else {
            initAuth();
        }
    </script>
</body>
</html>
{{ end }}
