{{ define "main" }}
<!doctype html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <!-- è®©Hugoæ’å…¥ä¸»é¢˜çš„æ‰€æœ‰å¤´éƒ¨å…ƒç´ ï¼ˆCSSã€Metaç­‰ï¼‰ -->
    {{ partial "head.html" . }}
    <style>
        /* æˆ‘ä»¬è‡ªå®šä¹‰çš„å¯†ç é¡µæ ·å¼ï¼Œä»…åœ¨æœªè®¤è¯æ—¶ç”Ÿæ•ˆ */
        .auth-body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .auth-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.1); text-align: center; }
        #blogContainer { display: none; } /* åˆå§‹éšè—åšå®¢å®¹å™¨ */
    </style>
    <!-- æ³¨å…¥æ–‡ç« æ•°æ® -->
    {{ partial "blog-data.html" . }}
</head>
<body class="auth-body">
    <!-- å¯†ç éªŒè¯ç•Œé¢ -->
    <div id="authBox" class="auth-box">
        <h2>ğŸ”’ ç§äººåšå®¢</h2>
        <p>è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š</p>
        <input type="password" id="passwordInput" placeholder="å¯†ç " autofocus />
        <button onclick="validatePassword()">è¿›å…¥</button>
        <p id="errorMsg" style="color: red; display: none;">å¯†ç é”™è¯¯</p>
    </div>

    <!-- åšå®¢å†…å®¹å®¹å™¨ (éªŒè¯åæ˜¾ç¤º) -->
    <!-- è¿™é‡Œå°†åŒ…è£¹æ•´ä¸ªä¸»é¢˜çš„ body å†…å®¹ -->
    <div id="blogContainer">
        <!-- ä¸»é¢˜çš„å¤´éƒ¨å¯¼èˆªæ  (åº”åŒ…å«æœç´¢æ¡†) -->
        {{ partial "header.html" . }}
        
        <!-- ä¸»é¢˜çš„ä¸»å†…å®¹åŒºåŸŸ -->
        <main>
            <!-- è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼Œæˆ‘ä»¬ç¨åå¡«å…… -->
            <div id="dynamicContent">
                <h1>æˆ‘çš„åšå®¢</h1>
                <div id="articleList"></div>
            </div>
        </main>
        
        <!-- ä¸»é¢˜çš„é¡µè„šç­‰ -->
        {{ partial "footer.html" . }}
    </div>

    <!-- è®©Hugoæ’å…¥ä¸»é¢˜çš„æ‰€æœ‰å°¾éƒ¨JSï¼ˆåŒ…æ‹¬æœç´¢åŠŸèƒ½ï¼‰ -->
    {{ partial "foot.html" . }}

    <script>
        // ========== é…ç½® ==========
        const correctHash = 'ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f'; // åŠ¡å¿…æ›¿æ¢
        const siteData = window.__HUGO_SITE_DATA__ || { pages: [] };
    
        // ========== æ ¸å¿ƒé€»è¾‘ ==========
        function checkAuth() {
            const savedHash = localStorage.getItem('auth_hash');
            // å¦‚æœæœ¬åœ°å­˜å‚¨çš„å“ˆå¸Œä¸æ­£ç¡®å“ˆå¸Œå®Œå…¨ä¸€è‡´ï¼Œåˆ™æ˜¾ç¤ºåšå®¢å†…å®¹
            return savedHash === correctHash;
        }
    
        function showView(isAuthenticated) {
            const authBox = document.getElementById('authBox');
            const blogContainer = document.getElementById('blogContainer');
            if (!authBox || !blogContainer) {
                console.error('é”™è¯¯ï¼šæœªæ‰¾åˆ°é¡µé¢ä¸Šçš„å…³é”®å…ƒç´  (authBox æˆ– blogContainer)');
                return;
            }
            if (isAuthenticated) {
                // å·²è®¤è¯ï¼šæ˜¾ç¤ºåšå®¢ï¼Œéšè—å¯†ç æ¡†
                authBox.style.display = 'none';
                blogContainer.style.display = 'block';
                document.body.classList.remove('auth-body');
                renderArticleList();
            } else {
                // æœªè®¤è¯ï¼šæ˜¾ç¤ºå¯†ç æ¡†ï¼Œéšè—åšå®¢
                authBox.style.display = 'block';
                blogContainer.style.display = 'none';
                document.body.classList.add('auth-body');
            }
        }
    
        async function validatePassword() {
            const input = document.getElementById('passwordInput').value;
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const inputHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
            if (inputHash === correctHash) {
                // éªŒè¯æˆåŠŸï¼šå­˜å‚¨å“ˆå¸Œï¼Œåˆ‡æ¢è§†å›¾
                localStorage.setItem('auth_hash', inputHash);
                showView(true);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
            return false; // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
        }
    
        function renderArticleList() {
            const container = document.getElementById('articleList');
            if (!siteData.pages || siteData.pages.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ–‡ç« ã€‚</p>';
                return;
            }
            let html = '';
            const articles = siteData.pages
                .filter(p => p.type && p.type.replace(/^"|"$/g, '') === 'posts')
                .sort((a, b) => new Date(b.date.replace(/^"|"$/g, '')) - new Date(a.date.replace(/^"|"$/g, '')));
    
            articles.forEach(article => {
                const cleanTitle = article.title.replace(/^"|"$/g, '');
                const cleanPermalink = article.permalink.replace(/^"|"$/g, '');
                const cleanDate = article.date.replace(/^"|"$/g, '');
                html += `
                    <li>
                        <a href="${cleanPermalink}"><strong>${cleanTitle}</strong></a>
                        <span style="color:#666; font-size:0.9em;"> - ${new Date(cleanDate).toLocaleDateString('zh-CN')}</span>
                    </li>
                `;
            });
            container.innerHTML = `<ul>${html}</ul>`;
        }
    
        // ========== é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¯†ç éªŒè¯è„šæœ¬å·²åŠ è½½ã€‚');
            // æ ¹æ®è®¤è¯çŠ¶æ€æ˜¾ç¤ºå¯¹åº”ç•Œé¢
            showView(checkAuth());
            // ä¸ºå¯†ç è¾“å…¥æ¡†ç»‘å®šå›è½¦é”®æäº¤
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        validatePassword();
                    }
                });
            }
        });
    </script>
</body>
</html>
{{ end }}
