<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§äººåšå®¢ - éªŒè¯è®¿é—®</title>
    <style>
        /* å¯†ç é¡µæ ·å¼ */
        body.auth-body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: sans-serif; }
        .auth-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
        /* åšå®¢å®¹å™¨åˆå§‹éšè— */
        #blogContainer { display: none; }
    </style>
</head>
<body class="auth-body">
    <!-- å¯†ç éªŒè¯ç•Œé¢ -->
    <div class="auth-box" id="authBox">
        <h1>ğŸ”’ ç§äººç©ºé—´</h1>
        <p>è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š</p>
        <input type="password" id="passwordInput" placeholder="å¯†ç " autofocus>
        <button onclick="validatePassword()">è¿›å…¥åšå®¢</button>
        <p id="errorMsg" style="color:red;display:none;">å¯†ç é”™è¯¯</p>
    </div>

    <!-- åšå®¢å†…å®¹å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
    <div id="blogContainer"></div>

    <script>
        // ========== æ–°å¢çš„â€œå®ˆå«é€»è¾‘â€ ==========
        // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰æˆ‘ä»¬çº¦å®šçš„éªŒè¯é€šè¿‡æ ‡è®°
        const urlParams = new URLSearchParams(window.location.search);
        const isFromAuth = urlParams.has('from') && urlParams.get('from') === 'auth';
        // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜æœ‰æ­£ç¡®çš„è®¤è¯å“ˆå¸Œ
        const isAuthed = localStorage.getItem('auth_hash') === 'ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f'; // åŠ¡å¿…æ›¿æ¢å“ˆå¸Œ
    
        // æƒ…å†µ1ï¼šå¦‚æœå·²è®¤è¯ï¼Œå¹¶ä¸”æ˜¯æ¥è‡ªéªŒè¯åçš„è·³è½¬ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºåšå®¢æ¡†æ¶ï¼Œåç»­ç”±JSå¡«å……å†…å®¹
        if (isFromAuth && isAuthed) {
            document.body.classList.remove('auth-body');
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('blogContainer').style.display = 'block';
            // ç›´æ¥å¼€å§‹åŠ è½½åšå®¢å†…å®¹ï¼ˆè¿™é‡Œä¼šå†æ¬¡fetchï¼Œä½†æºå¸¦äº†?from=authæ ‡è®°ï¼‰
            loadBlogContent();
        }
        // æƒ…å†µ2ï¼šå¦‚æœå·²è®¤è¯ï¼Œä½†ç›´æ¥è®¿é—®é¦–é¡µï¼Œåˆ™é™é»˜é‡å®šå‘åˆ°å¸¦æ ‡è®°çš„URLï¼Œè§¦å‘æƒ…å†µ1
        else if (isAuthed && !isFromAuth) {
            window.location.replace('/?from=auth');
            // ç”¨replaceè€Œä¸æ˜¯assignï¼Œé¿å…æµè§ˆå™¨å†å²è®°å½•å‡ºç°å¾ªç¯
        }
        // æƒ…å†µ3ï¼šæœªè®¤è¯ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œæ­£å¸¸æ˜¾ç¤ºä¸‹é¢çš„å¯†ç ç•Œé¢
        
        const correctHash = 'ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f';

        // å°†åŠ è½½åšå®¢å†…å®¹çš„é€»è¾‘æå–ä¸ºç‹¬ç«‹å‡½æ•°
        async function loadBlogContent() {
            const blogContainer = document.getElementById('blogContainer');
            try {
                const response = await fetch('/?from=auth');
                const html = await response.text();
                blogContainer.innerHTML = html;
                // ... é‡æ–°æ‰§è¡ŒJSçš„ä»£ç  ...
            } catch (error) {
                console.error('åŠ è½½åšå®¢å¤±è´¥:', error);
                blogContainer.innerHTML = '<p>æŠ±æ­‰ï¼ŒåŠ è½½å†…å®¹æ—¶å‡ºç°é”™è¯¯ã€‚</p>';
            }
        }

        async function validatePassword() {
            const input = document.getElementById('passwordInput').value;
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const inputHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            if (inputHash === correctHash) {
                // 1. å­˜å‚¨éªŒè¯çŠ¶æ€ï¼ˆä½¿ç”¨æ›´æŒä¹…çš„localStorageï¼‰
                localStorage.setItem('auth_hash', inputHash);
                // éªŒè¯é€šè¿‡åï¼Œè·³è½¬åˆ°å¸¦æ ‡è®°çš„é¦–é¡µï¼Œè§¦å‘â€œå®ˆå«é€»è¾‘â€çš„æƒ…å†µ1
                window.location.replace('/?from=auth');
                // 2. éšè—å¯†ç ç•Œé¢
                document.getElementById('authBox').style.display = 'none';
                document.body.classList.remove('auth-body');
                // 3. æ˜¾ç¤ºåšå®¢å®¹å™¨ï¼Œå¹¶åŠ è½½çœŸæ­£çš„åšå®¢é¦–é¡µå†…å®¹
                const blogContainer = document.getElementById('blogContainer');
                blogContainer.style.display = 'block';
                // ä½¿ç”¨fetchè·å–ç”±Hugoç”Ÿæˆçš„ã€çœŸå®çš„åšå®¢é¦–é¡µHTML
                fetch('/?from=auth') // æˆ‘ä»¬ä¸‹ä¸€æ­¥ä¼šåˆ›å»ºè¿™ä¸ªæ–‡ä»¶
                    .then(r => r.text())
                    .then(html => {
                        blogContainer.innerHTML = html;
                        // é‡æ–°æ‰§è¡Œæ–°åŠ è½½å†…å®¹ä¸­çš„JSï¼Œè®©æœç´¢ç­‰åŠŸèƒ½ç”Ÿæ•ˆ
                        blogContainer.querySelectorAll('script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            if (oldScript.src) {
                                newScript.src = oldScript.src;
                            } else {
                                newScript.textContent = oldScript.textContent;
                            }
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    });
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
        if (localStorage.getItem('auth_hash') === correctHash) {
            // å¦‚æœå·²è®¤è¯ï¼Œç›´æ¥æ˜¾ç¤ºåšå®¢å†…å®¹
            document.getElementById('authBox').style.display = 'none';
            document.body.classList.remove('auth-body');
            document.getElementById('blogContainer').style.display = 'block';
            fetch('/index_real.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('blogContainer').innerHTML = html;
                });
        }
    </script>
</body>
</html>
